<style lang='less'>
</style>
<template>
  <view class='container'>
    <zan-toptips
      id='zan-toptips'
      contetn='{{ content }}'
    />
    <view>
      <zan-tab
        list='{{ tabs }}'
        selected-id='{{ selectedId }}'
        height='45'
        bindtabchange='handleTabChange'
      />
      <view style="padding:20rpx;background-color:#fafafa;min-height:1000rpx">
        <zan-row>
          <repeat for='{{list}}'>
            <zan-col col='12'>
              <view @tap='tapItem({{item}})' style="height:260rpx;padding:20rpx;box-sizing:content-box;">
                <image style='width: 100%;height:260rpx;background-color:#ffffff' mode='widthFit' src='{{item.images.normal}}' lazy-load='true'></image>
              </view>
            </zan-col>
          </repeat>
        </zan-row>
      </view>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  // import Toptips from '../zanui/toptips/index'

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: 'WeDribbble',
      'usingComponents': {
        'zan-row': '../zanui/row/index',
        'zan-col': '../zanui/col/index',
        'zan-tab': '../zanui/tab/index',
        'zan-toptips': '../zanui/toptips/index'
      }
    }

    // é¡µé¢æ•°æ®
    data = {
      list: [],
      tabs: [{
        id: 'popular',
        title: 'çƒ­é—¨'
      }, {
        id: 'recent',
        title: 'æœ€æ–°'
      }],
      selectedId: 'popular',
      page: 1
    }

    // é¡µé¢æ–¹æ³•
    methods = {
      tapItem (item) {
        // é€‰ä¸­çš„ä½œå“å­˜ä¸ºå…¨å±€å˜é‡
        this.$parent.globalData.current = item

        // é¡µé¢è·³è½¬
        wepy.navigateTo({
          url: '/pages/shot?id=' + item.id
        })
      },
      handleTabChange({detail}) {
        if (this.selectedId !== detail) {
          this.selectedId = detail
          wepy.startPullDownRefresh()
        }
      }
    }

    //  ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    onShow() {
      // å½“é¡µé¢æ˜¾ç¤ºä¸”æ•°æ®ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨åŠ è½½
      if (this.list.length === 0) {
        // è°ƒç”¨å°ç¨‹åºä¸‹æ‹‰åˆ·æ–° API
        wepy.startPullDownRefresh()
      }
    }

    // å½“å°ç¨‹åºä¸‹æ‹‰åˆ·æ–°æ—¶è°ƒç”¨è‡ªå®šä¹‰åˆ·æ–°æ–¹æ³•
    onPullDownRefresh() {
      this.page = 1
      this.reload()
    }

    // å½“å°ç¨‹åºä¸Šæ‹‰åŠ è½½æ›´å¤šæ—¶è°ƒç”¨è‡ªå®šä¹‰åŠ è½½æ–¹æ³•
    onReachBottom() {
      this.page++
      this.loadmore()
    }

    // è‡ªå®šä¹‰åˆ·æ–°æ–¹æ³•
    async reload() {
      console.log('ç½‘ç»œè¯·æ±‚')
      var res = await wepy.request('https://api.dribbble.com/i1/shots/?&sort=' + this.selectedId + '&page=' + this.page + '&per_page=16&access_token=858782a9e363c9a5c434f356af378811649a6d376a40ae24c19a561f627b9afa')
      if (res.data.length) {
        this.list = res.data
        this.$apply()
      }

      // ç½‘ç»œè¯·æ±‚ç»“æŸååœæ­¢ä¸‹æ‹‰åˆ·æ–°
      wepy.stopPullDownRefresh()

      // å¼¹å‡ºæˆåŠŸå°æç¤º
      wepy.showToast({
        icon: 'none',
        title: 'åˆ·æ–°å®Œæˆ ğŸ˜Š',
        duration: 2000
      })
    }

    // è‡ªå®šä¹‰åŠ è½½æ–¹æ³•
    async loadmore() {
      console.log('ç½‘ç»œè¯·æ±‚')
      wepy.showLoading()
      var res = await wepy.request('https://api.dribbble.com/i1/shots/?&sort=' + this.selectedId + '&page=' + this.page + '&per_page=16&access_token=858782a9e363c9a5c434f356af378811649a6d376a40ae24c19a561f627b9afa')
      if (res.data.length) {
        this.list = this.list.concat(res.data)
        this.$apply()
      }

      wepy.hideLoading()
    }
  }
</script>
